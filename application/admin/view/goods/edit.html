{extend name="common/index"}
{block name="css"}
<style>
    {notempty name="data.img"}
    .image-url .layui-upload-drag .image-text {
        display: none;
    }
    {else/}
    .image-url .layui-upload-drag .image-preview {
        display: none;
    }
    {/notempty}

    .layui-input-block .layui-table input {
        width: 100%;
        height: 25px;
    }
    .layui-input-block .layui-table img {
        height: 30px;
        cursor: pointer;
    }
</style>
{/block}
{block name="content"}
<div class="layui-row">
    <form id="editForm" class="layui-form tpl-form-label-long" action="">
        <input type="hidden" name="id" id="id" value="{$data.id|default=''}">
        <input type="hidden" name="web_type" id="web_type" value="{$web_type|default=''}">
        <div class="layui-field-box">
            <div class="layui-main">
                <div class="layui-form-item">
                    <label class="layui-form-label">所属厂家：</label>
                    <div class="layui-input-block">
                        <select name="factory_id" lay-filter="get-classify" id="factory_id">
                            <option value="">请选择</option>
                            {volist name="$factoryList" id="vo"}
                            <option value="{$vo.id}" {eq name="vo.id" value="$data.factory_id|default=''"}selected{/eq}>{$vo.factory_name}</option>
                            {/volist}
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">商品分类：</label>
                    <div class="layui-input-block">
                        <select name="classify" lay-filter="get-classify-property" id="classify">
                            <option value="">请选择</option>
                            {volist name="$storeClassifyList" id="vo"}
                            <option value="{$vo.id}" {eq name="vo.id" value="$data.classify|default=''"}selected{/eq}>{$vo.name}</option>
                            {/volist}
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label"><span style="color: red;">*&nbsp;</span>商品名：</label>
                    <div class="layui-input-block">
                        <input type="text" name="goods_name" value="{$data.goods_name|default=''}" placeholder="请输入" class="layui-input"  lay-verify="required">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">厂家分类：</label>
                    <div class="layui-input-block">
                        <select name="factory_classify">
                            <option value="">请选择</option>
                            {volist name="$classifyList" id="vo"}
                            <option value="{$vo.id}" {eq name="vo.id" value="$data.factory_classify|default=''"}selected{/eq}>{$vo.classify_name}</option>
                            {/volist}
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">品牌：</label>
                    <div class="layui-input-block">
                        <input type="text" name="brand" value="{$data.brand|default=''}" placeholder="请输入" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">厂家产品型号：</label>
                    <div class="layui-input-block">
                        <input type="text" name="model_no" value="{$data.model_no|default=''}" placeholder="请输入" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">商城商品编号：</label>
                    <div class="layui-input-block">
                        <input type="text" name="goods_no" value="{$data.goods_no|default=''}" placeholder="请输入" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">材质：</label>
                    <div class="layui-input-block">
                        <select name="texture_id" id="texture_id">
                            <option value="">请选择</option>
                            {notempty name="$propertyList"}
                            {volist name="$propertyList" id="vo"}
                            <option value="{$vo.id}" {eq name="vo.id" value="$data.texture_id|default=''"}selected{/eq}>{$vo.property_name}</option>
                            {/volist}
                            {/notempty}
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">材质描述：</label>
                    <div class="layui-input-block">
                        <input type="text" name="texture_describe" value="{$data.texture_describe|default=''}" placeholder="请输入" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">风格：</label>
                    <div class="layui-input-block">
                        <select name="style_id" id="style_id">
                            <option value="">请选择</option>
                            {notempty name="$propertyList"}
                            {volist name="$propertyList" id="vo"}
                            <option value="{$vo.id}" {eq name="vo.id" value="$data.style_id|default=''"}selected{/eq}>{$vo.property_name}</option>
                            {/volist}
                            {/notempty}
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">风格描述：</label>
                    <div class="layui-input-block">
                        <input type="text" name="style_describe" value="{$data.style_describe|default=''}" placeholder="请输入" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">功能：</label>
                    <div class="layui-input-block">
                        <select name="function_id" id="function_id">
                            <option value="">请选择</option>
                            {volist name="$propertyList" id="vo"}
                            <option value="{$vo.id}" {eq name="vo.id" value="$data.function_id|default=''"}selected{/eq}>{$vo.property_name}</option>
                            {/volist}
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">功能描述：</label>
                    <div class="layui-input-block">
                        <input type="text" name="function_describe" value="{$data.function_describe|default=''}" placeholder="请输入" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">规格：</label>
                    <div class="layui-input-block">
                        <input type="text" name="specification" value="{$data.specification|default=''}" placeholder="请输入" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">包装方式：</label>
                    <div class="layui-input-block">
                        <input type="text" name="packaging" value="{$data.packaging|default=''}" placeholder="请输入" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">说明备注：</label>
                    <div class="layui-input-block">
                        <input type="text" name="remark" value="{$data.remark|default=''}" placeholder="请输入" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">排序：</label>
                    <div class="layui-input-block">
                        <input type="number" name="sort" value="{$data.sort|default=''}" placeholder="请输入" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">商品颜色：</label>
                    <div class="layui-input-block">
                        <table class="layui-table" lay-size="sm">
                            <thead>
                            <tr>
                                <th width="40%">颜色描述</th>
                                <th width="40%">图片</th>
                                <th width="20%" style="text-align: center;">
                                    <button type="button" class="layui-btn layui-btn-xs" onclick="addColorList(this);">添加</button>
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            {notempty name="data_color"}
                            {volist name="data_color" id="vo"}
                            <tr>
                                <td>
                                    <input type="hidden" name="color_list[{$key}][id]" value="{$vo.id}"/>
                                    <input type="text" name="color_list[{$key}][color]" value="{$vo.color}" class="layui-input"/>
                                </td>
                                <td>
                                    <div class="img-num color-img-{$key}">
                                        <input type="hidden" name="color_list[{$key}][img]" value="{$vo.img}">
                                        <img src="{$vo.img}">
                                    </div>
                                </td>
                                <td style="text-align: center;">
                                    <button type="button" class="layui-btn layui-btn-xs layui-btn-danger" onclick="delColorRow(this,{$vo.id});">删除</button>
                                </td>
                            </tr>
                            {/volist}
                            {/notempty}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">商品优惠券：</label>
                    <div class="layui-input-block">
                        <table class="layui-table" lay-size="sm">
                            <thead>
                            <tr>
                                <th width="40%">达到金额</th>
                                <th width="40%">优惠金额</th>
                                <th width="20%" style="text-align: center;">
                                    <button type="button" class="layui-btn layui-btn-xs" onclick="addCouponList(this);">添加</button>
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            {notempty name="data_coupon"}
                            {volist name="data_coupon" id="vo"}
                            <tr>
                                <td>
                                    <input type="hidden" name="coupon_list[1][id]" value="{$vo.id}"/>
                                    <input type="text" name="coupon_list[1][param_x]" value="{$vo.param_x}" class="layui-input"/>
                                </td>
                                <td>
                                    <input type="text" name="coupon_list[1][param_y]" value="{$vo.param_y}" class="layui-input"/>
                                </td>
                                <td style="text-align: center;">
                                    <button type="button" class="layui-btn layui-btn-xs layui-btn-danger" onclick="delCouponRow(this,{$vo.id});">删除</button>
                                </td>
                            </tr>
                            {/volist}
                            {/notempty}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">状态：</label>
                    <div class="layui-input-block">
                        <input type="radio" name="state" value="0" title="禁用" {eq name="$data.state|default=''" value="0"}checked{/eq}>
                        <input type="radio" name="state" value="1" title="启用" {eq name="$data.state|default=''" value="1"}checked{/eq}>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">审核状态：</label>
                    <div class="layui-input-block">
                        <input type="radio" name="audit_state" value="0" title="待审核" {eq name="$data.audit_state|default=''" value="0"}checked{/eq}>
                        <input type="radio" name="audit_state" value="1" title="审核通过" {eq name="$data.audit_state|default=''" value="1"}checked{/eq}>
                        <input type="radio" name="audit_state" value="2" title="审核不通过" {eq name="$data.audit_state|default=''" value="2"}checked{/eq}>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">审核结果说明：</label>
                    <div class="layui-input-block">
                        <input type="text" name="audit_remark" value="{$data.audit_remark|default=''}" placeholder="请输入" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">图文详情：</label>
                    <div class="layui-input-block">
                        <!-- 加载编辑器的容器 -->
                        <script id="goods_detail" name="detail" type="text/html">{$data.detail|default=''}</script>
                    </div>
                </div>
            </div>
            <div class="tpl-form-action">
                <button class="layui-btn layui-btn-radius layui-btn-lg" lay-submit lay-filter="formSubmit">保存</button>
            </div>
        </div>
    </form>
</div>

{/block}

{block name="script"}
<script type="text/javascript" src="__STATIC__/plugin/ueditor/ueditor.config.js"></script><!-- 编辑器配置文件 -->
<script type="text/javascript" src="__STATIC__/plugin/ueditor/ueditor.all.min.js"></script><!-- 编辑器源码文件 -->

<script type="text/javascript">
    layui.use(['form'], function () {
        var form = layui.form;

        //根据选中的厂家获取商品分类列表
        form.on('select(get-classify)', function (data) {
            $.post('{:url("getStoreClassify")}', {factory_id:data.value}, function (result) {
                var _html = "<option value=''>请选择</option>";
                $.each(result, function (key, val) {
                    _html += "<option value='"+val.id+"'>"+val.name+"</option>";
                });
                $("#classify").html(_html);
                form.render('select');
            });
        });

        //根据选中的商品分类获取属性列表
        form.on('select(get-classify-property)', function (data) {
            $.post('{:url("getStoreClassifyProperty")}', {classify_id:data.value}, function (result) {
                var html_style = "<option value=''>请选择</option>";//风格
                var html_texture = "<option value=''>请选择</option>";//材质
                var html_function = "<option value=''>请选择</option>";//功能
                $.each(result, function (key, val) {
                    if (val.type == 1) {
                        html_style += "<option value='"+val.id+"'>"+val.property_name+"</option>";
                    } else if (val.type == 2) {
                        html_texture += "<option value='"+val.id+"'>"+val.property_name+"</option>";
                    } else if (val.type == 3) {
                        html_function += "<option value='"+val.id+"'>"+val.property_name+"</option>";
                    }
                });
                $("#style_id").html(html_style);
                $("#texture_id").html(html_texture);
                $("#function_id").html(html_function);
                form.render('select');
            });
        });

        //监听提交
        form.on('submit(formSubmit)', function(data){
            var index = layer.load(2, {shade:[0.5,'#000'],time: 10*1000});
            $.post('{:url("save")}', $('#editForm').serialize(), function (result) {
                layer.close(index);
                if (result.code) {
                    layer.msg(result.msg, {shade:[0.5,'#000'],time:1000}, function () {
                        window.location.href = result.url;
                    });
                } else {
                    layer.alert(result.msg, {icon:2, title:'保存失败！'});
                }
            }, 'json');
            return false;
        });
    });

    //上传图片
    $('.img-num').each(function (key) {
        uploadImgAjax('.color-img-'+key, '{:url("uploadImg")}', 4096);//头像
    });

    function addColorList(element) {
        var row = $(element).closest('table').find('tbody').find('tr').length+1;

        var _html = '<tr>';
        _html += '<td>'+
            '<input type="hidden" name="color_list['+row+'][id]" />'+
            '<input type="text" name="color_list['+row+'][color]" class="layui-input"/>'+
            '</td>';
        _html += '<td>'+
            '<div class="color-img-'+row+'">'+
            '<input type="hidden" name="color_list['+row+'][img]">'+
            '<img src="__STATIC__/img/user_icon/holder.jpg">'+
            '</div>'+
            '</td>';
        _html += '<td style="text-align: center;">'+
            '<button type="button" class="layui-btn layui-btn-xs layui-btn-danger" onclick="delColorRow(this,0);">删除</button>'+
            '</td>';
        _html +=    '</tr>';
        $(element).closest('table').find('tbody').append(_html);
        uploadImgAjax('.color-img-'+row, '{:url("uploadImg")}', 4096);//头像
    }

    function delColorRow(element, id) {
        layer.confirm('确定继续吗？', function(index){
            if (id == 0) {
                layer.close(index);
                $(element).closest('tr').remove();
                return true;
            }

            $.post('{:url("deleteColor")}',{id:id}, function (result) {
                layer.close(index);
                if (result.code) {
                    $(element).closest('tr').remove();
                } else {
                    layer.alert(result.msg, {icon:2});
                }
            }, 'json');
        });
    }

    function addCouponList(element) {
        var row = $(element).closest('table').find('tbody').find('tr').length+1;

        var _html = '<tr>';
        _html += '<td>'+
            '<input type="hidden" name="coupon_list['+row+'][id]" />'+
            '<input type="text" name="coupon_list['+row+'][param_x]" class="layui-input"/>'+
            '</td>';
        _html += '<td>'+
            '<input type="text" name="coupon_list['+row+'][param_y]" class="layui-input"/>'+
            '</td>';
        _html += '<td style="text-align: center;">'+
            '<button type="button" class="layui-btn layui-btn-xs layui-btn-danger" onclick="delCouponRow(this,0);">删除</button>'+
            '</td>';
        _html +=    '</tr>';
        $(element).closest('table').find('tbody').append(_html);
    }

    function delCouponRow(element, id) {
        layer.confirm('确定继续吗？', function(index){
            if (id == 0) {
                layer.close(index);
                $(element).closest('tr').remove();
                return true;
            }

            $.post('{:url("deleteCoupon")}',{id:id}, function (result) {
                layer.close(index);
                if (result.code) {
                    $(element).closest('tr').remove();
                } else {
                    layer.alert(result.msg, {icon:2});
                }
            }, 'json');
        });
    }

    //实例化编辑器*
    UE.getEditor('goods_detail');
</script>

{/block}